<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InvestIQ - AI-Powered Stock Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --darker: #0f172a;
      --light: #f8fafc;
      --gray: #64748b;
      --border: #e2e8f0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
      color: #1e293b;
      min-height: 100vh;
    }
    
    /* Modern Navigation */
    nav {
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(10px);
      padding: 16px 40px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    
    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .nav-links {
      display: flex;
      gap: 8px;
      list-style: none;
    }
    
    .nav-links a {
      text-decoration: none;
      color: var(--gray);
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .nav-links a:hover {
      background: var(--light);
      color: var(--primary);
    }
    
    .nav-links a.active {
      background: var(--primary);
      color: white;
    }
    
    /* Container */
    .container {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 40px;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 30px;
    }
    
    /* Main Content Area */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    
    /* Modern Cards */
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
    }
    
    .card-header {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--dark);
    }
    
    /* Search Box */
    .search-container {
      display: flex;
      gap: 12px;
    }
    
    input {
      flex: 1;
      padding: 14px 20px;
      font-size: 1rem;
      border: 2px solid var(--border);
      border-radius: 12px;
      transition: all 0.3s;
      background: var(--light);
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    button {
      padding: 14px 28px;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
    }
    
    /* Modern Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      background: var(--light);
      padding: 8px;
      border-radius: 12px;
      overflow-x: auto;
    }
    
    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      border-radius: 8px;
      white-space: nowrap;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    
    .tab:hover {
      background: white;
      color: var(--primary);
    }
    
    .tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Content Area */
    .content-area {
      display: none;
      animation: fadeIn 0.3s;
    }
    
    .content-area.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modern Tables */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 20px 0;
      font-size: 0.9rem;
    }
    
    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    th:first-child {
      border-radius: 8px 0 0 0;
    }
    
    th:last-child {
      border-radius: 0 8px 0 0;
    }
    
    td {
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:hover {
      background: var(--light);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    .historical {
      background: #fafafa;
    }
    
    .projected {
      background: #eff6ff;
    }
    
    .calculated {
      color: var(--success);
      font-weight: 600;
    }
    
    /* Metric Cards */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .metric-card {
      background: linear-gradient(135deg, var(--light) 0%, white 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .metric-label {
      color: var(--gray);
      font-size: 0.85rem;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    /* AI Chatbot */
    .chatbot-container {
      position: sticky;
      top: 100px;
    }
    
    .chat-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      max-height: 800px;
    }
    
    .chat-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      border-radius: 16px 16px 0 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .chat-status {
      margin-left: auto;
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: var(--light);
    }
    
    .message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .message.ai .message-avatar {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .message.user .message-avatar {
      background: linear-gradient(135deg, var(--accent), var(--success));
    }
    
    .message-content {
      background: white;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.5;
      font-size: 0.9rem;
    }
    
    .message.user .message-content {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    
    .chat-input-container {
      padding: 20px;
      border-top: 1px solid var(--border);
      background: white;
      border-radius: 0 0 16px 16px;
    }
    
    .chat-input-wrapper {
      display: flex;
      gap: 12px;
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.9rem;
      resize: none;
      font-family: inherit;
      transition: all 0.3s;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
    }
    
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Learn Boxes */
    .learn-box {
      background: linear-gradient(135deg, #fff7ed, #fed7aa);
      border-left: 4px solid var(--warning);
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
    }
    
    .learn-box h3 {
      color: #c2410c;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }
    
    /* Messages */
    .message-box {
      padding: 16px 20px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid;
    }
    
    .success {
      background: #f0fdf4;
      border-color: var(--success);
      color: #166534;
    }
    
    .error {
      background: #fef2f2;
      border-color: var(--danger);
      color: #991b1b;
    }
    
    .warning {
      background: #fffbeb;
      border-color: var(--warning);
      color: #92400e;
    }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
      animation: loading 1.4s infinite;
    }
    
    @keyframes loading {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    
    .loading::before,
    .loading::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
      animation: loading 1.4s infinite;
    }
    
    .loading::before {
      left: -12px;
      animation-delay: -0.32s;
    }
    
    .loading::after {
      left: 12px;
      animation-delay: 0.32s;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 380px;
        z-index: 1000;
      }
      
      .chat-card {
        height: 500px;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 0 20px;
      }
      
      .card {
        padding: 20px;
      }
      
      .nav-links {
        display: none;
      }
      
      .chatbot-container {
        width: calc(100vw - 40px);
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <div class="logo">
        <span>ğŸ“</span>
        <span>InvestIQ</span>
      </div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="flashcards.html">Flashcards</a></li>
        <li><a href="video-course.html">Videos</a></li>
        <li><a href="stock-analysis-lab.html" class="active">Stock Analysis</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Main Content -->
    <div class="main-content">
      <!-- Search Card -->
      <div class="card">
        <div class="card-header">ğŸ” Analyze Any Company</div>
        <div class="search-container">
          <input 
            type="text" 
            id="symbolInput" 
            placeholder="Enter stock symbol (e.g., AAPL, BABA, MSFT...)"
            onkeypress="if(event.key==='Enter') analyzeStock()"
          >
          <button onclick="analyzeStock()">Analyze</button>
        </div>
      </div>

      <div id="messageBox"></div>

      <!-- Analysis Results -->
      <div id="analysisSection" style="display: none;">
        <div class="card" style="padding: 0; overflow: hidden;">
          <div class="tabs" style="border-radius: 0;">
            <button class="tab active" onclick="switchTab('overview')">ğŸ“Š Overview</button>
            <button class="tab" onclick="switchTab('income')">ğŸ’° Income</button>
            <button class="tab" onclick="switchTab('balance')">ğŸ¦ Balance</button>
            <button class="tab" onclick="switchTab('cashflow')">ğŸ’µ Cash Flow</button>
            <button class="tab" onclick="switchTab('integration')">ğŸ”— Integration</button>
            <button class="tab" onclick="switchTab('dcf')">ğŸ“ˆ DCF</button>
            <button class="tab" onclick="switchTab('assumptions')">âš™ï¸ Assumptions</button>
          </div>

          <div style="padding: 32px;">
            <div id="overview-content" class="content-area active">
              <div id="overviewData"></div>
            </div>
            <div id="income-content" class="content-area">
              <div id="incomeData"></div>
            </div>
            <div id="balance-content" class="content-area">
              <div id="balanceData"></div>
            </div>
            <div id="cashflow-content" class="content-area">
              <div id="cashflowData"></div>
            </div>
            <div id="integration-content" class="content-area">
              <div id="integrationData"></div>
            </div>
            <div id="dcf-content" class="content-area">
              <div id="dcfData"></div>
            </div>
            <div id="assumptions-content" class="content-area">
              <div id="assumptionsData"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Chatbot -->
    <div class="chatbot-container">
      <div class="chat-card">
        <div class="chat-header">
          <span>ğŸ¤–</span>
          <div>
            <h3>AI Financial Assistant</h3>
            <div style="font-size: 0.75rem; opacity: 0.9;">Ask me anything about finance</div>
          </div>
          <div class="chat-status"></div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message ai">
            <div class="message-avatar">ğŸ¤–</div>
            <div class="message-content">
              <strong>Hi! I'm your AI financial assistant.</strong><br><br>
              I can help you:
              <ul style="margin: 10px 0 0 20px;">
                <li>Understand financial metrics</li>
                <li>Explain company analysis</li>
                <li>Answer finance questions</li>
                <li>Guide you through the platform</li>
              </ul>
              What would you like to know?
            </div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea 
              id="chatInput" 
              class="chat-input" 
              placeholder="Ask about P/E ratio, DCF, or any financial concept..."
              rows="1"
              onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
            ></textarea>
            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
              <span>Send</span>
              <span>â†’</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let stockDatabase = null;
    let currentStock = null;
    let conversationHistory = [];
    
    // Load database
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('financial-model-data.json?' + Date.now());
        
        if (!response.ok) {
          showMessage('Database loading... Please upload financial-model-data.json', 'warning');
          return;
        }
        
        const data = await response.json();
        stockDatabase = data.stocks;
        
        showMessage(`âœ… Ready! ${Object.keys(stockDatabase).length} companies loaded`, 'success');
        setTimeout(() => document.getElementById('messageBox').innerHTML = '', 3000);
        
      } catch (error) {
        showMessage('Error loading database: ' + error.message, 'error');
      }
    });
    
    // AI Chat Functions
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      addMessage(message, 'user');
      input.value = '';
      
      // Disable send button
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      
      // Add loading indicator
      const loadingMsg = addMessage('Thinking...', 'ai', true);
      
      try {
        // Build context from current stock if available
        let context = '';
        if (currentStock) {
          context = `The user is currently analyzing ${currentStock.symbol} (${currentStock.name}). `;
          context += `Price: $${currentStock.price}, Market Cap: $${(currentStock.marketCap/1e9).toFixed(1)}B. `;
        }
        
        // Call Claude API
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [
              {
                role: 'user',
                content: `You are a helpful financial education assistant for InvestIQ, a platform teaching finance and stock analysis. ${context}

User question: ${message}

Provide a clear, educational answer. If explaining a concept, use simple language. If analyzing a stock, reference specific numbers when relevant. Keep responses concise (2-3 paragraphs max).`
              }
            ]
          })
        });
        
        const data = await response.json();
        
        // Remove loading message
        loadingMsg.remove();
        
        // Add AI response
        const aiResponse = data.content[0].text;
        addMessage(aiResponse, 'ai');
        
      } catch (error) {
        loadingMsg.remove();
        addMessage('Sorry, I encountered an error. Please try again.', 'ai');
        console.error('AI Error:', error);
      }
      
      // Re-enable send button
      sendBtn.disabled = false;
    }
    
    function addMessage(text, sender, isLoading = false) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = sender === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';
      
      const content = document.createElement('div');
      content.className = 'message-content';
      
      if (isLoading) {
        content.innerHTML = '<div style="position: relative; padding: 10px;"><span class="loading"></span></div>';
      } else {
        content.textContent = text;
      }
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      return messageDiv;
    }
    
    // Analyze stock (same as before but simplified)
    async function analyzeStock() {
      const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
      
      if (!symbol) {
        showMessage('Please enter a stock symbol', 'error');
        return;
      }
      
      if (!stockDatabase) {
        showMessage('Database not loaded yet. Please wait...', 'warning');
        return;
      }
      
      if (!stockDatabase[symbol]) {
        const available = Object.keys(stockDatabase).slice(0, 10).join(', ');
        showMessage(`${symbol} not found. Try: ${available}...`, 'error');
        return;
      }
      
      currentStock = stockDatabase[symbol];
      displayAnalysis(currentStock);
      
      document.getElementById('analysisSection').style.display = 'block';
      document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
      
      // Add AI message about the stock
      addMessage(`I see you're analyzing ${currentStock.symbol}! Feel free to ask me anything about this company's financials.`, 'ai');
    }
    
    // Display functions (abbreviated - same logic as before)
    function displayAnalysis(stock) {
      displayOverview(stock);
      displayIncome(stock);
      displayBalance(stock);
      displayCashFlow(stock);
      displayIntegration(stock);
      displayDCF(stock);
      displayAssumptions(stock);
    }
    
    function displayOverview(stock) {
      const metrics = stock.currentMetrics;
      const latestIncome = stock.incomeStatements[0] || {};
      const latestBalance = stock.balanceSheets[0] || {};
      
      document.getElementById('overviewData').innerHTML = `
        <h2 style="font-size: 2rem; margin-bottom: 10px;">${stock.symbol} - ${stock.name}</h2>
        <p style="color: var(--gray); margin-bottom: 30px;">${stock.sector} â€¢ ${stock.industry}</p>
        
        <div class="metric-grid">
          <div class="metric-card">
            <div class="metric-label">Stock Price</div>
            <div class="metric-value">$${stock.price.toFixed(2)}</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Market Cap</div>
            <div class="metric-value">$${(stock.marketCap / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">P/E Ratio</div>
            <div class="metric-value">${metrics.pe || 'N/A'}</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Revenue (TTM)</div>
            <div class="metric-value">$${(latestIncome.revenue / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Net Income</div>
            <div class="metric-value">$${(latestIncome.netIncome / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Total Assets</div>
            <div class="metric-value">$${(latestBalance.totalAssets / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ROE</div>
            <div class="metric-value">${metrics.roe}%</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Debt/Equity</div>
            <div class="metric-value">${metrics.debtToEquity || 'N/A'}</div>
          </div>
        </div>
        
        <div class="learn-box" style="margin-top: 30px;">
          <h3>ğŸ’¡ Ask the AI</h3>
          <p>Want to understand these metrics better? Try asking the AI chatbot:</p>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>"What does P/E ratio mean?"</li>
            <li>"Is ${stock.symbol}'s ROE good?"</li>
            <li>"Explain ${stock.symbol}'s market cap"</li>
          </ul>
        </div>
      `;
    }
    
    function displayIncome(stock) {
      const statements = stock.incomeStatements.slice(0, 5);
      
      let tableHTML = `
        <h2 style="margin-bottom: 20px;">Income Statement</h2>
        
        <table>
          <thead>
            <tr>
              <th>Item</th>
              ${statements.map(s => `<th>${s.date.substring(0, 4)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Revenue</strong></td>
              ${statements.map(s => `<td class="historical">$${(s.revenue / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Cost of Revenue</td>
              ${statements.map(s => `<td class="historical">$${(s.costOfRevenue / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td><strong>Gross Profit</strong></td>
              ${statements.map(s => `<td class="calculated">$${(s.grossProfit / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td style="padding-left: 30px; color: var(--gray);">Gross Margin %</td>
              ${statements.map(s => `<td>${((s.grossProfit / s.revenue) * 100).toFixed(1)}%</td>`).join('')}
            </tr>
            <tr>
              <td>Operating Expenses</td>
              ${statements.map(s => `<td class="historical">$${(s.operatingExpenses / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td><strong>EBIT</strong></td>
              ${statements.map(s => `<td class="calculated">$${(s.ebit / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Interest Expense</td>
              ${statements.map(s => `<td class="historical">$${(Math.abs(s.interestExpense) / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Pre-tax Income</td>
              ${statements.map(s => `<td class="calculated">$${(s.pretaxIncome / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Income Tax</td>
              ${statements.map(s => `<td class="historical">$${(s.incomeTax / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td><strong>Net Income</strong></td>
              ${statements.map(s => `<td class="calculated" style="font-size: 1rem; background: #f0fdf4;">$${(s.netIncome / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td style="padding-left: 30px; color: var(--gray);">Net Margin %</td>
              ${statements.map(s => `<td style="font-weight: 600;">${((s.netIncome / s.revenue) * 100).toFixed(1)}%</td>`).join('')}
            </tr>
          </tbody>
        </table>
      `;
      
      document.getElementById('incomeData').innerHTML = tableHTML;
    }
    
    function displayBalance(stock) {
      const statements = stock.balanceSheets.slice(0, 5);
      
      let tableHTML = `
        <h2 style="margin-bottom: 20px;">Balance Sheet</h2>
        
        <table>
          <thead>
            <tr>
              <th>Item</th>
              ${statements.map(s => `<th>${s.date.substring(0, 4)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="${statements.length + 1}" style="background: var(--primary); color: white; font-weight: 700; padding: 10px;">ASSETS</td></tr>
            <tr>
              <td>Cash & Equivalents</td>
              ${statements.map(s => `<td class="historical">$${(s.cashAndEquivalents / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Accounts Receivable</td>
              ${statements.map(s => `<td class="historical">$${(s.accountsReceivable / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Inventory</td>
              ${statements.map(s => `<td class="historical">$${(s.inventory / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>PP&E (Net)</td>
              ${statements.map(s => `<td class="historical">$${(s.ppe / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td><strong>Total Assets</strong></td>
              ${statements.map(s => `<td class="calculated" style="font-weight: 700; background: #eff6ff;">$${(s.totalAssets / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            
            <tr><td colspan="${statements.length + 1}" style="background: var(--primary); color: white; font-weight: 700; padding: 10px; padding-top: 20px;">LIABILITIES</td></tr>
            <tr>
              <td>Accounts Payable</td>
              ${statements.map(s => `<td class="historical">$${(s.accountsPayable / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Long-term Debt</td>
              ${statements.map(s => `<td class="historical">$${(s.longTermDebt / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td><strong>Total Liabilities</strong></td>
              ${statements.map(s => `<td class="calculated" style="font-weight: 700;">$${(s.totalLiabilities / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            
            <tr><td colspan="${statements.length + 1}" style="background: var(--primary); color: white; font-weight: 700; padding: 10px; padding-top: 20px;">EQUITY</td></tr>
            <tr>
              <td><strong>Total Equity</strong></td>
              ${statements.map(s => `<td class="calculated" style="font-weight: 700; background: #f0fdf4;">$${(s.totalEquity / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            
            <tr>
              <td><strong>CHECK: Assets = Liab + Equity</strong></td>
              ${statements.map(s => {
                const balanced = Math.abs(s.totalAssets - (s.totalLiabilities + s.totalEquity)) < 1e6;
                return `<td style="font-weight: 700; color: ${balanced ? 'var(--success)' : 'var(--danger)'};">${balanced ? 'âœ“ PASS' : 'âœ— FAIL'}</td>`;
              }).join('')}
            </tr>
          </tbody>
        </table>
      `;
      
      document.getElementById('balanceData').innerHTML = tableHTML;
    }
    
    function displayCashFlow(stock) {
      const statements = stock.cashFlows.slice(0, 5);
      
      let tableHTML = `
        <h2 style="margin-bottom: 20px;">Cash Flow Statement</h2>
        
        <table>
          <thead>
            <tr>
              <th>Cash Flow Item</th>
              ${statements.map(s => `<th>${s.date.substring(0, 4)}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Operating Cash Flow</strong></td>
              ${statements.map(s => `<td class="historical">$${(s.operatingCashFlow / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Capital Expenditures</td>
              ${statements.map(s => `<td class="historical">($${(Math.abs(s.capex) / 1e9).toFixed(2)}B)</td>`).join('')}
            </tr>
            <tr>
              <td><strong>Free Cash Flow</strong></td>
              ${statements.map(s => `<td class="calculated" style="font-weight: 700; background: #f0fdf4;">$${(s.freeCashFlow / 1e9).toFixed(2)}B</td>`).join('')}
            </tr>
            <tr>
              <td>Dividends Paid</td>
              ${statements.map(s => `<td class="historical">($${(Math.abs(s.dividendsPaid) / 1e9).toFixed(2)}B)</td>`).join('')}
            </tr>
          </tbody>
        </table>
      `;
      
      document.getElementById('cashflowData').innerHTML = tableHTML;
    }
    
    function displayIntegration(stock) {
      document.getElementById('integrationData').innerHTML = `
        <h2 style="margin-bottom: 20px;">ğŸ”— How the Three Statements Connect</h2>
        
        <div style="background: var(--light); padding: 30px; border-radius: 12px; margin: 30px 0;">
          <pre style="font-size: 0.85rem; line-height: 1.8; color: var(--dark); overflow-x: auto;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      INCOME STATEMENT                             â”‚
â”‚                                                                   â”‚
â”‚  Revenue                                                          â”‚
â”‚  - Cost of Revenue                                                â”‚
â”‚  = Gross Profit                                                   â”‚
â”‚  - Operating Expenses                                             â”‚
â”‚  = EBIT                                                           â”‚
â”‚  - Interest Expense  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  = Pre-tax Income                       â”‚                         â”‚
â”‚  Ã— (1 - Tax Rate)                       â”‚                         â”‚
â”‚  = NET INCOME  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚               â”‚
                          â†“               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CASH FLOW STATEMENT                             â”‚
â”‚                                                                   â”‚
â”‚  Net Income  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                         â”‚
â”‚  + Depreciation                         â”‚                         â”‚
â”‚  - Î” Working Capital                    â”‚                         â”‚
â”‚  = Operating Cash Flow                  â”‚                         â”‚
â”‚  - CapEx                                â”‚                         â”‚
â”‚  = FREE CASH FLOW                       â”‚                         â”‚
â”‚                                         â”‚                         â”‚
â”‚  Financing:                             â”‚                         â”‚
â”‚    + Debt Issuance                      â”‚                         â”‚
â”‚    - Debt Repayment                     â”‚                         â”‚
â”‚    - Dividends                          â”‚                         â”‚
â”‚  = Net Change in Cash  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚         â”‚
                                          â”‚         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BALANCE SHEET                                â”‚
â”‚                                                                   â”‚
â”‚  ASSETS:                                                          â”‚
â”‚    Cash  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚    Accounts Receivable                                            â”‚
â”‚    Inventory                                                      â”‚
â”‚    PP&E                                                           â”‚
â”‚                                                                   â”‚
â”‚  LIABILITIES:                                                     â”‚
â”‚    Accounts Payable                                               â”‚
â”‚    Debt  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                   â”‚
â”‚  EQUITY:                                                          â”‚
â”‚    Prior Equity + Net Income - Dividends                          â”‚
â”‚                                                                   â”‚
â”‚  CHECK: Assets = Liabilities + Equity                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          </pre>
        </div>
      `;
    }
    
    function displayDCF(stock) {
      const fcfs = stock.cashFlows.slice(0, 5).map(cf => cf.freeCashFlow);
      const avgFCF = fcfs.reduce((a, b) => a + b, 0) / fcfs.length;
      
      const growthRate = 0.05;
      const wacc = 0.095;
      const terminalGrowth = 0.03;
      
      let projectedFCF = [];
      let pv = [];
      
      for (let i = 1; i <= 5; i++) {
        const fcf = avgFCF * Math.pow(1 + growthRate, i);
        const discount = Math.pow(1 + wacc, i);
        projectedFCF.push(fcf);
        pv.push(fcf / discount);
      }
      
      const terminalValue = (projectedFCF[4] * (1 + terminalGrowth)) / (wacc - terminalGrowth);
      const pvTerminal = terminalValue / Math.pow(1 + wacc, 5);
      
      const enterpriseValue = pv.reduce((a, b) => a + b, 0) + pvTerminal;
      const latestBalance = stock.balanceSheets[0] || {};
      const equityValue = enterpriseValue + latestBalance.cashAndEquivalents - latestBalance.longTermDebt;
      const fairValue = equityValue / stock.sharesOutstanding;
      const upside = ((fairValue - stock.price) / stock.price) * 100;
      
      document.getElementById('dcfData').innerHTML = `
        <h2 style="margin-bottom: 20px;">ğŸ“ˆ DCF Valuation Model</h2>
        
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>FCF</th>
              <th>Discount Factor</th>
              <th>Present Value</th>
            </tr>
          </thead>
          <tbody>
            ${projectedFCF.map((fcf, i) => `
              <tr>
                <td>Year ${i + 1}</td>
                <td class="projected">$${(fcf / 1e9).toFixed(2)}B</td>
                <td>${(1 / Math.pow(1 + wacc, i + 1)).toFixed(3)}</td>
                <td class="calculated">$${(pv[i] / 1e9).toFixed(2)}B</td>
              </tr>
            `).join('')}
            <tr style="border-top: 2px solid var(--primary);">
              <td colspan="3"><strong>Terminal Value (Year 6+)</strong></td>
              <td class="calculated" style="font-weight: 700;">$${(pvTerminal / 1e9).toFixed(2)}B</td>
            </tr>
          </tbody>
        </table>
        
        <div class="metric-grid" style="margin-top: 30px;">
          <div class="metric-card">
            <div class="metric-label">Enterprise Value</div>
            <div class="metric-value">$${(enterpriseValue / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Equity Value</div>
            <div class="metric-value">$${(equityValue / 1e9).toFixed(1)}B</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Fair Value / Share</div>
            <div class="metric-value">$${fairValue.toFixed(2)}</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Current Price</div>
            <div class="metric-value">$${stock.price.toFixed(2)}</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">Upside / (Downside)</div>
            <div class="metric-value" style="color: ${upside > 0 ? 'var(--success)' : 'var(--danger)'};">${upside > 0 ? '+' : ''}${upside.toFixed(1)}%</div>
          </div>
        </div>
      `;
    }
    
    function displayAssumptions(stock) {
      document.getElementById('assumptionsData').innerHTML = `
        <h2 style="margin-bottom: 20px;">âš™ï¸ Key Modeling Assumptions</h2>
        
        <div style="background: var(--light); padding: 20px; border-radius: 12px; margin: 10px 0;">
          <p style="margin: 5px 0;"><strong>Revenue Growth Rate:</strong> 5.0%</p>
          <p style="color: var(--gray); font-size: 0.9rem; margin-left: 20px;">Based on historical trends and market conditions</p>
          
          <p style="margin: 15px 0 5px 0;"><strong>Terminal Growth Rate:</strong> 3.0%</p>
          <p style="color: var(--gray); font-size: 0.9rem; margin-left: 20px;">Long-term GDP growth assumption</p>
          
          <p style="margin: 15px 0 5px 0;"><strong>WACC:</strong> 9.5%</p>
          <p style="color: var(--gray); font-size: 0.9rem; margin-left: 20px;">Weighted Average Cost of Capital (discount rate)</p>
          
          <p style="margin: 15px 0 5px 0;"><strong>Tax Rate:</strong> 21%</p>
          <p style="color: var(--gray); font-size: 0.9rem; margin-left: 20px;">U.S. corporate tax rate</p>
        </div>
        
        <div class="learn-box" style="margin-top: 30px;">
          <h3>ğŸ’¡ Ask the AI About Assumptions</h3>
          <p>Want to understand these better? Try asking:</p>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>"Why is terminal growth rate 3%?"</li>
            <li>"How do you calculate WACC?"</li>
            <li>"What if I change the growth rate to 7%?"</li>
          </ul>
        </div>
      `;
    }
    
    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('.content-area').forEach(area => {
        area.classList.remove('active');
      });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabName + '-content').classList.add('active');
      event.target.classList.add('active');
    }
    
    // Show message
    function showMessage(msg, type) {
      document.getElementById('messageBox').innerHTML = `<div class="card message-box ${type}">${msg}</div>`;
    }
  </script>
</body>
</html>
